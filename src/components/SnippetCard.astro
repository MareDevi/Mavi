---
import type { CollectionEntry } from 'astro:content';
import { formatDate, formatDateMobile, processMarkdown } from '@/utils/markdown';
import { getOptimizedFormat } from '@/utils/images';
import ImageWrapper from './ImageWrapper.astro';

interface Props {
  snippet: CollectionEntry<'snippets'>;
  eager?: boolean;
}

const { snippet, eager = false } = Astro.props;

const { title, description, date, tags, language, image: rawImage, imageAlt } = snippet.data;
const { excerpt } = processMarkdown(snippet.body || '');
const displayDescription = description || excerpt;

// Normalize optional image field (support Obsidian [[image]] syntax)
const image = (() => {
  if (!rawImage) return null;
  let imageValue = rawImage;
  if (Array.isArray(rawImage)) {
    imageValue = rawImage[0];
  }
  if (typeof imageValue !== 'string') return null;
  if (imageValue.startsWith('[[') && imageValue.endsWith(']]')) {
    return imageValue.slice(2, -2);
  }
  return imageValue;
})();
---

<article class="group rounded-lg border border-primary-200 dark:border-primary-700 bg-primary-50 dark:bg-primary-900 hover:border-highlight-300 dark:hover:border-highlight-600 transition-all duration-200 shadow-sm">
  <a href={`/snippets/${snippet.id}`} class="block" aria-label={`View snippet: ${title}`}>
    {image && (
      <div class="overflow-hidden rounded-t-lg bg-primary-100 dark:bg-primary-800" style="aspect-ratio: 16/9;">
        <ImageWrapper
          src={(() => {
            if (!image) return '';
            if (image.startsWith('http')) return image;
            let path = image;
            if (path.startsWith('images/') || path.startsWith('attachments/')) {
              path = path.replace(/^(images|attachments)\//, '');
            }
            return getOptimizedFormat(path);
          })()}
          basePath={(() => {
            if (!image) return '';
            if (image.startsWith('http')) return '';
            if (image.startsWith('attachments/')) {
              return '/snippets/attachments/';
            }
            return `/snippets/${snippet.id}/`;
          })()}
          alt={imageAlt || `Image for snippet: ${title}`}
          class="w-full h-full group-hover:scale-102 transition-transform duration-300"
          width={800}
          height={450}
          format="webp"
          quality={85}
          loading={eager ? 'eager' : 'lazy'}
          fetchpriority={eager ? 'high' : 'auto'}
        />
      </div>
    )}

    <div class={`p-4 ${image ? 'rounded-b-lg' : 'rounded-lg'}`}>
      <div class="flex flex-wrap items-center gap-2 text-sm text-primary-500 dark:text-primary-400 mb-2">
        <time datetime={date.toISOString()}>
          <span class="hidden sm:inline">{formatDate(date)}</span>
          <span class="sm:hidden">{formatDateMobile(date)}</span>
        </time>
        {language && (
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-primary-100 dark:bg-primary-800 text-primary-700 dark:text-primary-200 border border-primary-200 dark:border-primary-700">
            {language}
          </span>
        )}
      </div>

      <h3 class="text-base font-semibold text-primary-900 dark:text-primary-100 leading-relaxed group-hover:text-highlight-600 dark:group-hover:text-highlight-400 transition-colors">
        {title}
      </h3>

      {displayDescription && (
        <p class="text-primary-600 dark:text-primary-300 text-sm leading-relaxed mt-2 line-clamp-3">
          {displayDescription}
        </p>
      )}

      {tags && tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-2">
          {tags.slice(0, 4).map((tag) => (
            <span class="inline-flex items-center px-2.5 py-1 text-xs text-primary-600 dark:text-primary-300 bg-primary-100 dark:bg-primary-800 rounded-full border border-primary-200 dark:border-primary-700">
              {tag}
            </span>
          ))}
          {tags.length > 4 && (
            <span class="text-xs text-primary-500 dark:text-primary-400 bg-primary-50 dark:bg-primary-800 px-2.5 py-1 rounded-full border border-primary-200 dark:border-primary-700">
              + {tags.length - 4} more
            </span>
          )}
        </div>
      )}
    </div>
  </a>
</article>
